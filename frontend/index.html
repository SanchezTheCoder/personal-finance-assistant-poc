<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finance - Personal Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Instrument+Sans:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/ui/styles.css?v=15" />
  </head>
  <body>
    <div class="shell">
      <header class="topbar">
        <div class="topbar-brand">
          <div class="topbar-icon">
            <svg viewBox="0 0 24 24"><rect x="4" y="14" width="4" height="7" rx="1"/><rect x="10" y="9" width="4" height="12" rx="1"/><rect x="16" y="4" width="4" height="17" rx="1"/></svg>
          </div>
          <div>
            <h1 class="topbar-title">Finance</h1>
            <p class="topbar-subtitle">Personal Assistant</p>
          </div>
        </div>
        <div class="topbar-actions">
          <button id="theme-toggle" class="btn btn-secondary btn-sm btn-icon" type="button" aria-label="Toggle theme">
            <svg class="icon-sun" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>
            <svg class="icon-moon" viewBox="0 0 24 24"><path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
          </button>
          <button id="routing-detail-button" class="btn btn-secondary btn-sm" type="button">
            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10zM7 10l4 3-4 3v-6zm5 5h5v-2h-5v2z"/></svg>
            Live Trace
          </button>
          <span class="status-chip">
            <span class="pulse-dot"></span>
            Logged in
          </span>
        </div>
      </header>

      <main class="grid">
        <aside class="sidebar">
          <section class="card account-card" id="account-card">
            <div class="section-title">Brokerage Account</div>
            <div class="balance-block">
              <div class="label">Total value</div>
              <div class="value" id="account-balance">--</div>
              <div class="meta">
                <span id="account-date">--</span>
                <span class="ytd-badge" id="ytd-badge"></span>
              </div>
            </div>
            <div class="breakdown-grid" id="account-breakdown">
              <div class="breakdown-item">
                <div class="breakdown-label">Invested</div>
                <div class="breakdown-value" id="account-invested">--</div>
              </div>
              <div class="breakdown-item">
                <div class="breakdown-label">Cash</div>
                <div class="breakdown-value" id="account-cash">--</div>
              </div>
              <div class="breakdown-item">
                <div class="breakdown-label">Settled</div>
                <div class="breakdown-value" id="account-settled">--</div>
              </div>
            </div>
          </section>

          <section class="card" id="positions-card">
            <div class="card-header">
              <div class="section-title">Positions</div>
              <span class="card-badge" id="positions-count"></span>
            </div>
            <div id="positions-list">
              <div class="loading-placeholder">Loading positions...</div>
            </div>
          </section>

          <section class="card" id="activity-card">
            <div class="section-title">Recent Activity</div>
            <div id="activity-list">
              <div class="loading-placeholder">Loading activity...</div>
            </div>
          </section>

          <section class="card" id="transfers-card">
            <div class="section-title">Transfers</div>
            <div id="transfers-list">
              <div class="loading-placeholder">Loading transfers...</div>
            </div>
          </section>
        </aside>

        <section class="chat-panel">
          <div class="chat-header">
            <div class="chat-avatar">
              <svg viewBox="0 0 24 24"><path d="M12 3C6.5 3 2 6.58 2 11c0 2.13 1.05 4.07 2.75 5.5.05.6-.42 2.17-2.75 4.5 0 0 3.55 0 6.47-2.5 1.1.32 2.29.5 3.53.5 5.5 0 10-3.58 10-8s-4.5-8-10-8z"/></svg>
            </div>
            <div class="chat-header-info">
              <h2>Assistant</h2>
              <div class="chat-header-status">
                <span class="pulse-dot"></span>
                <span>Online</span>
              </div>
            </div>
          </div>

          <div id="chat" class="chat">
            <div id="welcome-state" class="welcome-state">
              <h3>How can I help you today?</h3>
              <p>Ask about your positions, performance, transfers, quotes, or account details.</p>
              <div class="suggestion-chips">
                <button class="suggestion-chip" data-query="What are my current positions?">My positions</button>
                <button class="suggestion-chip" data-query="How is AAPL performing?">AAPL performance</button>
                <button class="suggestion-chip" data-query="Show me recent activity">Recent activity</button>
                <button class="suggestion-chip" data-query="What is my account value?">Account value</button>
              </div>
            </div>
            <div id="typing-indicator" class="typing-indicator">
              <div class="typing-bubble">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>
            </div>
          </div>

          <form id="chat-form" class="chat-form">
            <div class="input-wrapper">
              <input
                id="input"
                type="text"
                placeholder="Ask about activity, positions, performance, or quotes"
                autocomplete="off"
              />
              <button type="submit" class="send-btn" id="send-btn" disabled>
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
              </button>
            </div>
          </form>
        </section>

        <aside class="routing-panel" aria-label="Live routing details">
          <div class="routing-header">
            <div>
              <h3>Live Routing Details</h3>
              <p>Latest request trace</p>
            </div>
            <button id="routing-close" class="modal-close" type="button" aria-label="Close">
              ✕
            </button>
          </div>
          <div class="routing-teaching">
            <div class="routing-teaching-header">
              <div class="section-title">Teaching Explanation</div>
              <button id="routing-explain" class="routing-button" type="button">Explain this run</button>
            </div>
            <div id="routing-teaching-text" class="routing-text muted">
              Click "Explain this run" to generate a short walkthrough of how the backend handled this request.
            </div>
          </div>
          <div class="routing-summary" id="routing-summary">&mdash;</div>
          <div class="routing-body">
            <div class="routing-section">
              <div class="section-title">Utterance</div>
              <div id="routing-utterance" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section">
              <div class="section-title">Intent</div>
              <div id="routing-intent" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section">
              <div class="section-title">Routing</div>
              <div id="routing-mode" class="routing-text">&mdash;</div>
              <div id="routing-confidence" class="routing-text muted">&mdash;</div>
              <div id="routing-router" class="routing-text muted">&mdash;</div>
            </div>
            <div class="routing-section" data-routing-section="extracted" data-empty-hide="true">
              <div class="section-title">Extracted Params</div>
              <ul id="routing-extracted" class="routing-list"></ul>
            </div>
            <div class="routing-section" data-routing-section="router-diagnostics" data-empty-hide="true">
              <div class="section-title">Router Diagnostics</div>
              <ul id="routing-router-diagnostics" class="routing-list"></ul>
            </div>
            <div class="routing-section" data-routing-section="missing" data-empty-hide="true">
              <div class="section-title">Missing Params</div>
              <div id="routing-missing" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section" data-routing-section="candidates" data-empty-hide="true">
              <div class="section-title">Candidates</div>
              <ul id="routing-candidates" class="routing-list"></ul>
            </div>
            <div class="routing-section" data-routing-section="tools" data-empty-hide="true">
              <div class="section-title">Tool Calls</div>
              <ul id="routing-tools" class="routing-list"></ul>
            </div>
            <div class="routing-section" data-routing-section="tool-params" data-empty-hide="true">
              <div class="section-title">Tool Params</div>
              <ul id="routing-tool-params" class="routing-list"></ul>
            </div>
            <div class="routing-section" data-routing-section="context" data-empty-hide="true">
              <div class="section-title">Context Summary</div>
              <ul id="routing-context" class="routing-list"></ul>
            </div>
            <div class="routing-section">
              <div class="section-title">Latency</div>
              <div id="routing-latency" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section" data-routing-section="latency-breakdown" data-empty-hide="true">
              <div class="section-title">Latency Breakdown</div>
              <ul id="routing-latency-breakdown" class="routing-list"></ul>
            </div>
            <div class="routing-section" data-routing-section="grounding" data-empty-hide="true">
              <div class="section-title">Grounding</div>
              <div id="routing-grounding" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section" data-routing-section="grounding-valid" data-empty-hide="true">
              <div class="section-title">Grounding Validation</div>
              <div id="routing-grounding-valid" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section" data-routing-section="formatter" data-empty-hide="true">
              <div class="section-title">Formatter</div>
              <div id="routing-formatter" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section" data-routing-section="session" data-empty-hide="true">
              <div class="section-title">Session State</div>
              <ul id="routing-session" class="routing-list"></ul>
            </div>
            <div class="routing-section" data-routing-section="policy" data-empty-hide="true">
              <div class="section-title">Policy Gate</div>
              <div id="routing-policy" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section">
              <div class="section-title">Model</div>
              <div id="routing-model" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section" data-routing-section="prompt" data-empty-hide="true">
              <div class="section-title">Prompt</div>
              <div id="routing-prompt" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section">
              <div class="section-title">Tokens / Cost</div>
              <div id="routing-tokens" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section" data-routing-section="retry" data-empty-hide="true">
              <div class="section-title">Retry Count</div>
              <div id="routing-retry" class="routing-text">&mdash;</div>
            </div>
            <div class="routing-section">
              <div class="section-title">Trace</div>
              <a id="routing-trace-link" class="routing-link" target="_blank" rel="noreferrer">Open trace</a>
            </div>
          </div>
        </aside>
      </main>
    </div>

    <div id="routing-modal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-overlay" data-close="true"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Production-Grade Routing (Scale View)</h3>
          <button class="modal-close" data-close="true" aria-label="Close">
            ✕
          </button>
        </div>
        <div class="modal-body">
          <p>
            Large brokers typically use a multi-stage routing stack: a fast rules
            layer for obvious intents, a lightweight classifier for ambiguous
            queries, and a policy layer that enforces data access and tool
            gating. The goal is low latency, high determinism, and minimal tool
            fan-out.
          </p>
          <ul>
            <li>Rules &amp; heuristics for high-precision intent mapping.</li>
            <li>
              Model-based rerouting only when confidence is below a threshold.
            </li>
            <li>
              Strict policy checks: entitlements, account scope, privacy, and
              tool allowlists.
            </li>
            <li>
              Feature flags, A/B experiments, and shadow routing for safety.
            </li>
            <li>
              Observability on routing confidence, fallbacks, and tool fan-out.
            </li>
          </ul>
          <p>
            This POC mirrors that pattern: deterministic rules first, optional
            LLM reroute for ambiguity, then minimal tools + grounded response.
          </p>
        </div>
      </div>
    </div>

    <script src="/ui/app.js?v=23"></script>
  </body>
</html>
